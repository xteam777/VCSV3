VIRCESS
вход по запросу кнопкой в клиенте как анидеск

проверка пароля на хосте. не хранить пароли на гейте, а использовать ртцкомманд. неактивные кнопки серым фоном. ид жирным
после гибер пклиент долго подкобчается. по кнопке сразу

на активации подвисает, но точки идут. кмпоненты отдельными потоками?
Ддуп в хелпер
Проверять пароль в гейте при трансляции функций деск файл чат
вначале тупит иззза аэро?
//добавить тип прокси хттп/хттпс/сокс. 
//	socks=127.0.0.1:9050
при потере связи закрывает окно настроек. абаут и настройки не трогать. только то что касается подключений
при добавлении компа не обновляется список
блочить кнопки нового компа и другие при отправке на сервер. кнопки сделать стандартные. Кнопки отжимать при ок или аборт
два языка. по умолчанию из локали
инсталлятор. запуск или установка и запуск службы. работа со службой пример в оригинале
обновлятор
дизайн клиента верхушки, файлов, два скриншота. remox.com
you need EV code signing certificate to SmartScreen ByPass
файлы
	убрать точки. добавить кнопку вверх. вверх по бэкспейс
	передавать на гейт текущий ид консольного клиента и на него переводить подключение файлов. через хвид. при изменении ид консольной сессии обновлять
		если не залогинен то передавать НОЛОГИН
		коннектить на активного и деск и файлы и чат? при смене активного что? WMWTSSESSIONCHANGE
		если на сервере никто не залогинен при передаче файлов на консоль что будет? ошибка невозможно начать передачу файлов тк это запрещено на удаленном компьютере
		делать рефреш после операции с файлами
		картинки файлов нормально
		кнопка файлов панели не отжимается

Комманд. Сначала смотрим что запущено потом собираем инфу
	Запрос списка процессов. Имя компа. ИП адреса внутри и внешней. Запуск файла
	Пароли рдп впн


выбор монитора
тор опция. тор соединение на гейт и на каждое подключение? пока медленно работает и никому такая скорость не нужна
	компонент торклиент. свойства: порты, мост, прокси. старт стоп
	тор отдельно нужен для работы через онион адреса без наших серверов
!контроль тупит если юзер с порталгейта не вишибается
!ддуп глючит если скомпилен на вин 11 а запускается на винсервер 2012
при потере связи переподключение в эту же форму. реконнект не отображать в статусе
//шифровать всю запись логина релогина, пинга, гетпартнеринфо. длятор не нужно
в форме пароля картинка на белом фоне
hostlogout acclogout не работают на гейте. нет ид сессии
при статусе юзер не найден отменяем пендинг, поток коннекта и ошибка
готов к подключению писать только если подключен пклиент хоста. в потоке ожидающий (один последний. добавить дату сброса статуса) отображать первыми. если их нет то по статусу
если нет коннекта через минуту виснет
	все события в цс? активацию в цс? 
	TaskBarIconUpdate ShowDevicesPanel SetStatus SetStatusString вызываются очень часто. обновлять вцл в потоке
	UpdatePendingStatus; btnViewDesktop.Caption := 'ПОДКЛЮЧИТЬСЯ' - тут виснет
	SetConnectedState SetStatusString
рн клиент out of memory

проверку лицензии делать на главном гейте и не подключать если перебор часов. считать часы по подключениям с хостов. если не залогинен под купленой лицензией

хранить клиенты деревом (кто/к кому+гейт для соединений) отрубать неактивные точечно без цикла. пока мало народу не горит
	активные соединения с возможностью завершения. пока нет лицензирования не горит
		100001132_7D58D60E20DA4B43B2CBBF11EED0B2BC логоффить зависшие по дереву а не перебором
	//если пропал гейт отправить релогон всем его клиентам при следующем пинге гейта. рестарт мгейта если есть хосты на нем. идет повторная активация с получением нового мгейта
	//при логине и логоффе хоста на гл гейте логоффить его на старом мгейте если гейт изменен. сейчас это тормозов не дает
	//таблица статы по мгейтам
	//сохранять в инф последний удачный порт
	//	при активации хоста и при лоад сеттингс и при новом потоке ставить последний удачный порт если есть
	//при отмене подключения удалять соединение на гейте и логоффить пклиента на минигейте. само удалится. сейчас это тормозов не дает
	//при пропаже мгейта переподключение. если через 5 секунд после получения гейта порт не подобран запрашиваем другой гейт. проверить

проверить прокси
делать логофф акка и хоста при засыпании
при чтении пароля в сервисе проверять дату изменения файла. проверить
таже папка логов в хелпер. проверить



//протестить два гейта на разных портах. блочить порты
//вывод начала и конца процедур в лог с ключем дебаг
//гейты
	//порт подключения хоста к мгейту хранить на ггейте. передавать в пинге
	//таблица гейтов не нужна. все гейты должны ломиться на главный
	//4 порта (80, 8080, 443, 5938) у каждого гейта? проверять доступность порта в клиенте. на клиента передавать только ип
	//гл гейт на отдельный сервер на таже порты
	//режим гейта главный / подчиненный
	//видеть стату количество юзеров и соединений на гейтах
последний квадратик по пклиенту. перенести в онстарт?
Disconnect при завершении не нужно?
NotifyAccountsOnHostLogin сделать также на изменение добавление удаление
тс через сутки медленно передается инпут. тим тоже тупит
	изза клипбоарда? не удалось открыть? большой обьем? тормоит изза экселя
		рн сст. ScrUtils.Put_Clipboard. в тиме тоже перестал работать буфер
	эксепшены?
	проверить скорость передачи через гейт. как в кастом
инфо: запускать без элевате но с hightestAvailable чтобы можно было управлять при открытом диспетчере задач
под правами юзера просит админский доступ при входе на терминал. прога пытается внести изменения
	подписать сертификатом? бесплатным и закинуть его в доверенные. взять фрилансера чтоб показал на любой проге. устанавливать всем свой сертификат?
		https://habr.com/ru/post/112289/
	//запускать клиентов под системой (как определять юзера для ид, если закроет и откроет заново уже под собой?)? запуск через айпиц к службе
	//все хосты пклиентов создавать на службе и обмен через хелперы. запуск клиентов без элевате?
	https://culhu.ru/archives/22737
	если служба инпут всегда передавать через хелпер
		https://stackoverflow.com/questions/67232163/sendinput-function-from-user32-dll-doesnt-work-if-task-manager-is-opened
		https://stackoverflow.com/questions/56595640/sendinput-fails-on-uac-prompt
	запуск клиентов от системы с передачей параметром имени юзера?
елевате должен быть создан прямо до его запуска, иначе не работает. почему непонятно
проверить переподключение ResetLogin / DeskHost.Active True...
	перезапуск только при общем релогине. при ошибках пклиентов восстановление связи. при ошибке юи надо DeskHost.Active = True?
при пропадании инета перегружать только пклиент хоста? Остальные может продолжат работать? По какой ошибке они отваливаются?
	//при пропаже гл гейта перегружаем все
перед стоп ретриотчерс 0?
//сообщение открытия буфера убрать
после потери связи создавать заново пклиентхост?
рн сст при пропаже гейта виснет
	hcAccountsConnectLost (вообще надо отрабатывать?) вцл в отдельных потоках обновлять. события пклиента это потоки
создавать пклиентов в отдельных потоках? хватит крит секций
два подключения к десктопу консоли не мешают друг другу? каждый будет ждать скрина предыдущего......хранить дату скрина и если она новая не использовать мьютексы
//каждый раз создавать новое соединение с гейтом для многопоточности. пклиенты жрут ресурсы только компа что несущественно. на гейте только запись логгедин
ускорить отправку инпута через хелпер через ммф?
DisableAero опцией. по умолчанию отключена. она наверно для старых компов
тупило изза того что при активации хоста всем пклиентам ставился логин хоста!!!!
Obj это asPtr или asObj?
если два юзера и если оба залочены каждый видит сас декстоп. а если под одним зайти второй что увидит?
	если сеанс залочен и это не консоль то выдавать локед? выход же не сделан из сеанса, значит он активен
многопоточная картинка. прирост скорости за счет потоков и ядер
	обновление блоков по запросу. одновременно разными потоками будет быстрее. а читаем только где изменения что тоже быстрее
	всегда брать картинку из хелпера? без мьютекса на чтение
форма детурс как юи
слать активные соединения на сервер при открытии и закрытии юи. кнопка посыла релогина


если залочили терминал передавать локед. PDesktopHost.HaveScreen?
//после потери гейта не подключается. вместо отключения делать ресет логин
//	при быстройм переключении не пришел релогин
//повторно такое же подключение не открывать?
изменение компа не отражается в списках компов на других хостах
//рн сст. со временем не подключается. надо перезапускать гейт. bm tw15 не подключается после рестарта компа
//переподключение юи. хост релогин при пропаже гейта. без дисконненкта не переподключается
//	если ранее было получен ид то не делать дисконнект, а только актив тру
бм при потере гейта после активации нет ид и статус две красных и выдает локед. после обновления ос и установки делфи исправилось
	сбросить до заводcких и проверить
инфо: кад работает только через хелпер
почему ид после 118 идет 1119? ид = сид юзера+сид винды гейт начал тупить при получении нового ид
из хелпера изображение должна брать только консоль? без многопоточности да. с мп надо делать компонентами либо читать можно если есть файл ммф без мьютеков
лог хранить в профиле?
инфо: тормозить может сетфокус свернутого окна
скрыть / показать панель не срабатывает иногда
удаленный курсор через хелпер
если открыт десктоп главное окно не сворачивается. со второго щелчка переключается на основное окно с управления
девтс служба не устанавливается. к консоли не подключается
кнопку компы подвинуть вправо
при простом запуске запускать один хелпер от имени системы. как его потом убивать при закрытии клиента?
	посылать инпут через хелпер
	если только запуск при закрытии убивать хелпер только в этой сессии
	деинсталляция
вернуть модальность
девтс админ при пропаже гейта на второй раз виснет
при изменении прокси менять на всех клиентах на компе?
при изменении ширины окна кривой масштаб
	мг неправильно масштабируется. должно быть растянуто на весь экран
	если локед то в размер главного окна
	при развороте окна выходит за панель задач
	миникнопка разворота во весь экран срабатывает не каждый раз
передача файлов запрещена если пользователь не вошел в систему. если клиент - консоль и подключаемый партнер неактивен
при запросе к консоли на передачу файлов она должна вернуть текущий ид клиента активной сессии через гейт. на него и подключать
интерфейс передачи файлов эксплорером. это всегда новое подключение. хранилище убрать
кнопку кад выключить если нет службы на партнере и включать если появилась
кнопку передачи файлов выключить если нет ни одного залогиненного юзера (если активно окно сас) и включать если появился
на маингейте сделать список запросов/активных соединений
	rtcAccounts.GatewayServerList сделать RtcInfo+List+хранить список соединений для лицензирования
первый скрин всегда черный
//при изменении пути менять путь в службе. нужно только для тестов
//включить форслогофф? сессии сами кроются
сервер получать с сайта?
передача сочетаний. не передается пуск
при закрытии из трея висит процесс. скип реквестс?
при чтении пароля проверять файл по дате изменения?


//сделать потоки со сравнением и передавать только изменения. обработка изменения расширения. таймер или флаг в ммф
dxgi и передавать из хелпере только дельту? хелпер постоянно рисует скрин у себя пока клиент считывает. клиент перестал считывать, таймаут и перестает рисовать? для dxgi не нужна система
цвет статуса ошибки красный
иногда не входит в аккаунт
	fManualLogoff сделать. сбрасывать при ручном логоне
//tCheckServiceStartStopTimer GetActiveConsoleSessionID - consecutive exceptions
//не работает кнопка свернуть иногда
//иконка не уходит
//комп иногда не удаляется. пустой uid
//картинку верхнюю уменьшить высоту
//девтс консоль локед
//девтс консоль двм!!! после динамической памяти?
//подогнать размер панелей под размер маин меню
//сравнить битблт через гди, память и диб и вставить лучший в вирцесс
ssl
coinpayments.net
регистрация через сайт только (для посещаемости) //в том числе
продавать только одновременные каналы со всем функционалом и обновлениями
перевод клиента и сайта на английский

гди+ и обработка экрана по частям потоками. исправить пересчеты pargb
	приоритет тредов критический
	передавать куски в формате пнг
	злиб компресс
	обновление кусков через сендмесседж
	отправлять из хелпера в клиента дельтами
	отправлять на гейт дельтами
	когда хелпер спросил первый скрин сделали скрин и перезапустии таймер. таймер 1 сек. таймер отключает потоки
	60-100 потоков
	//передавать через гейт пнг


//переделать пендинг
//	при статусе отключен отменять пендинги
//	прервать закрывает открытое окно
//	пендинг иногда закрывает только открывшийся десктоп
//	если отменить подключение оно все равно открывается
//	после закрытия окна оно из пендинга не удаляется?
//	если при подключении окно открыто то пендинг не уходит. а при отмене пендинга закрывается открытое окно
//	4888 btnViewDesktopClick CurrentPendingItem = nil
надо делать переключение сессий иначе все придется переделывать через хелпер
//	на консоли кнопка блокировки компа не работает
//	host.SpecialKey отсылать все через хелпер
	буфер через хелпер: копировать, вырезать, вставить
		при нажатии копи отправляем на хелпер копи и через 250 мс запрашиваем содержимое буфера и отправляем на клиента содержимое буфера
		при изменении буфера отправляем содержимое через хелпер
//формы немодальные. проверить подключение к клиенту с модальным окном. все нормально подключается!!!
//    PassForm: TfIdentification;
//    GForm: TGroupForm;
//    DForm: TDeviceForm;
сообщения через RegisterWindowsMessage
на гейты отдельный датапровайдер
	разделить маингейт и гейт
	поддерживать постоянные соединения с гейтов на маингейт и отрубать по пингу
	протестить смену адреса гейта на пклиенте. убрать stop и active false
	при пропадании гейта переключать на другой гейт (реактивация)
черный экран сделать потоком через SendMessage
	черный экран только если есть залогиненный пользователь в консоли
	показывать только для консоли?
	поток старт/стоп если есть хоть один подключенный клиент который запросил черный экран. при отключении клиента стоп
доп кнопки как в рдп



//	Value of type TRtcFunctionInfo allready assigned. Set to NULL before used
//в ui при изменении havescreen менять обложку?
автообновление
копирование через детурс
	использовать передачу файлов через десктоп только для детурс
		когда будет детурс сделать переподключение сессий, тк служба будет использовать экслорер не своей сессии и окно копирования не выведешь
			получить путь можно через хелпер. переподключение не обзательно. хелпер создаст окно копирования. но данные из консоли в окно копирования как передавать?
видеодрайвер. для быстрой работы консоли, и других клиентов
передавать на гейт и клиента что сменилась консольная сессия и ид новой консольной сессии и заменять десктоп
	https://docs.microsoft.com/ru-ru/windows/desktop/api/winsvc/nc-winsvc-lphandler_function_ex
		передавать на гейт в логине что это сервис
		передавать на гейт в пинге ид текущего консольного клиента
			получать на клиенте текущий ид как хавескрин
		при изменении текущего ид переподключать десктоп на него
	если переключаемся по рдп к консольной сессии
		подключения остаются	
		переподключаем консоль
установщик
	два режима: установка и только запуск
	запуск и удаление службы
	служба ставится всегда
	при установке вопрос нужен ли постоянный доступ
	tCheckLockedState всегда дб включено
	запускать клиентов один раз при запуске службы или создании новой сессии. разрешить выход в клиенте. mCanClose
	клиент должен запускаться из автозагрузки. запуск хелпера оставить в службе
	netsh winhttp import proxy source=ie

//консоль на девтс жрет 80 мб и не подключается после пропажи интернета
//	хелпер не выдает скрин
//пклиент виснет после десктопа и отрубания гейта
//статус логина консоли мг не всегда приходит на клиента при запуске консоли потом клиента после запуске после гейта
//девтс админ со временем не подключается
//	таймер пклиента не включается	
//при показе курсора на мг админе ав на клиенте. rtcpDesktopControlUI 667. видимость курсора?
//	на девтс свой курсор скрывается. не скрывать никогда







//в клиенте getdata и ping непонятно сделаны. сделать разными клиентами?
	пинг для акка, гетдата для хоста. вкл выкл таймеры по коннект/дисконнект клиентов//
//висит в состоянии активации 4821 with cmAccounts, Data.NewFunction('Host.Ping') do function already assigned
//	https://rtc.teppi.net/sdkarchive/indexa261a261.html?cmd=viewtopic&topic_id=18&section_id=9&sid=
//девтс админ без службы подключается как локед
//tPClientReconnectTimer в отдельном потоке
//курсор у мг админа в контейнере не виден
//клиент при переактивации виснет
//	виснет при логоффе мг админа
//	пклиент виснет и таймеры не работают
//		виснет после неккольких логоффов пклиента по таймауту
//на мг нов админ не срабатывает дабл клик
//	GetCursorInfoWithAttach
//	теперь не показывает курсор партнера
//		ui.Container.Cursor
//		получать курсор аттачем в отдельном потоке
//		как это сделано в хелпере?
//клиент на ноуте виснет
//	1020 гейт логгед аут при релогине. также в аккаунтах

везде проверки:
  if Result.isType = rtc_Exception then
  begin
//  LogOut(nil);
//    lblStatus.Caption := Result.asException;
  end
  else
  if Result.isType <> rtc_Record then
  begin
    SetStatusString('Некорректный ответ от сервера');
  end

//	крит секция нужна во всех местах для одного ресурса.
//		в основном потоке не трогаем такие ресурсы. всегда создаем дочерние. в основной переходим через synchronyze
//		на разные ресурсы разные крит секции
//		ЕСЛИ В КРИТ СЕКЦИИ ПИШЕТСЯ ИЛИ ЧИТАЕТСЯ ОБЬЕКТ, ТО ОН ТОЖЕ ДОЛЖЕН БЫТЬ В КРИТ СЕКЦИИ ВО ВСЕХ ДРУГИХ МЕСТАХ ГДЕ РАБОТАЮТЬ ПОТОКИ
//		{ Важно: Методы и свойства объектов из библиотеки визуальных компонентов
//		могут использоваться только в рамках вызова метода Synchronize


правильные переподключение и завершение
	https://rtc.teppi.net/sdkarchive/indexb129b129.html?cmd=viewtopic&topic_id=67&section_id=9&sid=
	https://rtc.teppi.net/sdkarchive/index4a9a4a9a.html?cmd=viewtopic&topic_id=43&section_id=1
	https://rtc.teppi.net/sdkarchive/index5bda-25bda.html?cmd=viewtopic&topic_id=51&section_id=1
управлять службой через галку
	когда будет установщик:
		если поставили то отменяем удаление службе или потом устанавливаем ее. потом запускаем
		если снята то удаляем службу (помечаем) оставляя запущенной
		галку сохраняем в инф
	при удалении службы ничего не завершать и не перезапускать
	те запускать только так где не запущено при старте службы. только обновить галку
если тс сервер не стартовал то "Session\" для ммф убрать. проверить хелперы и WTSApi.IsSessionLocked на вин10 без службы тс. 
	проверка на запущенность тс. http://www.delphisources.ru/pages/faq/base/is_term_service.html
	протестить без службы терминалов
	протестить на хп
//при килл процесс в проекте убивать только процесс в текущей сессии
группа последние подключения
scaling https://rtcforum.teppi.net/index.php?topic=1296.0
после добавления компа прокрутка кривая
удаленный курсор проверить на вин7, 10
в таблице Devices добавить индекc по хешу. добавить таблицу соответствий ид хеш и поле взято булево
мелкий шрифт в истории
удалять пклиентов при логоффе. удалять неиспользуемые пклиенты?
отключение экрана делает черный экран мнеже? rtc-X.rtcBlankOutForm
добавил новый комп в группу. на другом компе не добавился/неудалился/не изменился
при посадке батареи куча ав в клиенте
как формировать ид если в терминале если у одного пользователя несколько сессий? проверить на тв
2. при смене консольной сессии {завершать текущий консольный клиент без логоффа и стартовать в новой активной сессии} ЛОГОФФ старого ИД и ПЕРЕЛОГИН С НОВЫМ ИД. отработать смену юзера
3. если в старой сессии был запущен клиент то делать ему логофф-логон
pmDevice.PopupPoint переделать на нее вызовы GetCursorPos
//интерфейс чата
правила бм дублируются. в проекте есть -ADDRULES
метки Доделать 
лицензирование помесячно. три часа в месяц бесплатный период
выбирать ближайший по ип адресу гейт

//переход на mysql. accuracer или nexusdb. сначала протестить
//после ночи подключения к мг на клиенте мг too many... 
	на мг не меняется курсор. GetCursorInfo и GetCursorPos error 87 параметр задан неверно. теперь типа невидимый курсор
//	переход на d7? https://www.transl-gunsmoker.ru/2009/01/dllmain_04.html
переподключение десктопа при перезапуске партнера. повторное подключение в тоже окно юи?
наложение локед битмапа на последний скрин. http://pblog.ru/lab/?p=436
rtcpDesktopHost Put_Clipboard Get_Clipboard делать из хелпера?
подключения вкладками
скрывать обои опция на клиенте
форму регион удалить
масштабирование экрана без рывков
активные соединения
запись видео
	https://github.com/rdp/screen-capture-recorder-to-video-windows-free
	http://alax.info/blog/1716
	http://www.delphimaster.net/view/8-1111615744/8
	https://www.visioforge.com/video-capture-sdk.html
цвета полоникс. левая часть темносиние (как вин10) контролы на белом фоне. справа (скисок компов) наоборот
звук?
впн?
desktop duplication в клиента. и хелпер?
	http://www.cyberforum.ru/cpp-cli/thread2038484.html
	https://ru.stackoverflow.com/questions/704154/%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-desktop-duplication-api
проверить все на вин2000? для вин2000 https://github.com/murrayju/CreateProcessAsUser/blob/master/ProcessExtensions/ProcessExtensions.cs enumeratesessions не работает. консольная сессия всегда 0. In Windows 2000 the console is always session 0
изменение разрешения экрана по списку доступных
выбор монитора. мониторы на разных квладках?
	https://rsdn.org/forum/winapi/1004704
	https://stackoverflow.com/questions/29045966/how-to-take-a-screenshot-of-a-second-screen-monitor
при запуске проверка на запущенность в текущей сессии клиента и хелпера в них самих. http://www.sql.ru/forum/784059/createfilemapping-i-openfilemapping-2-oe-prilozhenie-ne-vidit-1-oe. FindWindow работает внутри сессии?


//гетвей виснет. TRtcPortalGateway.OnCheckDisconnectedHostsTimerTimer отключено. при подключении и получении статуса проверять активность и завершать. rtcPortalGate force отключено. rtcAccounts.CheckDisconnectedHosts
//	2018-07-22 16:54:41.219; rtcAccounts doHostLogOut Start
//	2018-07-22 16:56:30.353; 100000045 [176.120.238.70]: Login check
//	и аут оф рендж
//кривой скрин и assertion failure. вернуть все ассерты?
//	rtcScrPlayback.TRtcScreenPlayback.PaintScreen()
//	rtcScrPlayback.TRtcScreenDecoder.SetScreenData($2D15A18)
//	rtcCompress 1140
//на мг подвисает на sysfreemem. av на гейте потом виснет. rtcLog константы проставить. заменить массивы на rtcinfo. разные крит секции на разные действия
//pipes unit. RaiseLastOSError to xLog       LOG_THREAD_EXCEPTIONS:=True; LOG_EXCEPTIONS:=True
//после ввода пароля в фус теряется связь и заново подключается. когда новый юзер первый раз логинится?
//добавить опцию EnableComposition() аэро
//протестить при подключении к клиенту без службы на залоченном компе. если партнер не служба при блокировке изображение прыгает
//структуры https://resources.infosecinstitute.com/windows-gui-forensics-session-objects-window-stations-and-desktop/#gref
//имена сессий. https://jdebp.eu/FGA/windows-nt-session.html
//добавить acl. FullObjectAccess? к винста и декскопам
//определение удаленный сеанс или локальный. https://msdn.microsoft.com/en-us/library/aa380798(v=vs.85).aspx
//протестить без многопоточности. отловить ав...
//сравнение битмапов memcmp
//создать поток и его переключать https://github.com/Microsoft/Windows-classic-samples/blob/master/Samples/DXGIDesktopDuplication/cpp/DesktopDuplication.cpp
//acl. перевести функцию с мс https://support.microsoft.com/ru-ru/help/165194/createprocessasuser-windowstations-and-desktops
//https://www.remkoweijnen.nl/blog/2007/11/08/how-to-launch-a-process-in-a-terminal-session-2/
//https://www.codeproject.com/Articles/35773/Subverting-Vista-UAC-in-Both-32-and-64-bit-Archite
//https://www.codeproject.com/Articles/133372/Monitoring-of-Logon-Logout-in-Terminal-and-Client
//http://qaru.site/questions/149829/how-to-start-a-process-from-windows-service-into-currently-logged-in-users-session
//https://github.com/murrayju/CreateProcessAsUser
//кривой первый скрин. при перезапуске клиента/повторном подключении все норм. какие то ав? иногда ав в фримем
//определение размера ммф. https://stackoverflow.com/questions/34860452/extracting-shared-memorys-size
//хелпер много весит. FastDIB File procs change to MMF
//	http://rsdn.org/forum/winapi
//	http://delphimaster.net/view/1-76427
//
//	https://msdn.microsoft.com/ru-ru/library/windows/desktop/dd183402(v=vs.85).aspx http://www.vb-helper.com/howto_make_gray.html 
//	https://www.codeproject.com/script/Content/ViewAssociatedFile.aspx?rzp=%2FKB%2FGDI%2Fmagnify%2F%2Fmagnifier_src.zip&zep=cdib.cpp&obid=3571&obtid=2&ovid=1
//HBITMAP to MMF
//	https://msdn.microsoft.com/ru-ru/library/windows/desktop/dd183402(v=vs.85).aspx
//RLE to DIB
//keybdevent отсылает кнопки. оставить его или весть кбд интерфейс
//	все процедуры и переменные key press/down... убрать из хелпера
//uSEWaitThread.pas использовать где нужно... запуск хелперов и клиентов из службы?
//переделать переподключение пклиентов. tGReconnect отключен
//кнопки свернуть/развернуть меню не работают удаленно без стилей. октоунклик не срабатывает

//      xLog('Logging on to the Gateway to force the Host process to close.');
//      LoadSetup;
//      PClient.GParamsLoaded := True; // this will force all other Hosts to close
//      cnt:=100;
//      repeat
//        Dec(cnt);
//        Sleep(100);
//      until PClient.GParamsLoaded or (cnt<=0);
//      PClient.Active:=False;
//      PClient.Stop;

То есть нужно всего лишь получить токен пользователя, ассоциированного с нужной сессией. В XP это делается тривиально благодаря наличию функции WTSQueryUserToken. В Win2K можно просто перечислить все процессы, найти explorer.exe в нужной сессии и взять его токен (правильнее будет иметь программу, которая автоматически запустится при входе пользователя в систему и вызовет сервис, чтобы тот имел возможность получить токен; это уже обсуждалось здесь неоднократно).
Открываем ProcessExplorer от sysinternals.com и находим хендл интересующей станции (например, выделим процесс, у которого Command Line = "C:\WINDOWS\System32\svchost.exe -k netsvcs", а в нижней части в списке хендлов находим "\Windows\WindowStations\Service-0x0-3e7$"), правой мышой -> Properties... -> вкладка Безопасность -> в верхнем списке выделяем группу Администраторы, а в нижнем списке ставим разрешения на Delete или/и Modify State. Затем эти же разрешения можно убрать обратно. После этого интересующая оконная станция становится доступной для перечисления.
Не знаю, что происходит после действий поставить/убрать галочки, но подозреваю, что выставляется также какой-то незримый флаг (вероятно, именно WINSTA_ENUMDESKTOPS), который в нижнем списке Process Explorer'а не присутствует.
